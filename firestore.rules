rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    // Helper function to check if a user is a team member of a specific business
    function isTeamMember(businessId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/businesses/$(businessId)/teamMembers/$(request.auth.uid));
    }

    // Helper function to get team member permissions
    function getTeamMemberPermissions(businessId) {
      return get(/databases/$(database)/documents/businesses/$(businessId)/teamMembers/$(request.auth.uid)).data.permissions;
    }

    // Helper function to check if a user is the business owner
    function isBusinessOwner(businessId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/businesses/$(businessId)).data.businessInfo.ownerUid == request.auth.uid;
    }

    // Invitations: Top-level collection
    match /invitations/{invitationId} {
      allow read, delete: if isAuthenticated() && resource.data.invitedBy == request.auth.uid;
      allow read: if isAuthenticated() &&
                    resource.data.email.toLowerCase() == request.auth.token.email.toLowerCase() &&
                    resource.data.status == 'pending';
      allow create: if isAuthenticated();
      allow update: if false;
    }

    // Users: Allow read/write for own document, delete for business owner
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && isBusinessOwner(userId);
    }

    // Business-specific data
    match /businesses/{businessId} {
      // Allow read for owner and team members with any role, write for owner only
      allow read: if isBusinessOwner(businessId) || isTeamMember(businessId);
      allow write: if isBusinessOwner(businessId);

      // TeamMembers: Allow read for team members, write/delete for owner
      match /teamMembers/{userId} {
        allow read: if isAuthenticated() && (isBusinessOwner(businessId) || request.auth.uid == userId);
        allow write, delete: if isBusinessOwner(businessId);
      }

      // Invitations: Subcollection
      match /invitations/{invitationId} {
        allow read: if isBusinessOwner(businessId) || isTeamMember(businessId);
        allow write: if isBusinessOwner(businessId);
      }

      // Sheets: Allow read for viewers/editors, write for editors
      match /sheets/{sheetId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).sheets.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).sheets.role == 'editor');
      }

      // SheetsStructure: Allow read for viewers/editors, write for editors
      match /sheetsStructure/{structureId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).sheets.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).sheets.role == 'editor');
      }

      // Records: Allow read for viewers/editors, write for editors
      match /records/{recordId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).sheets.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).sheets.role == 'editor');
      }

      // Objects: Allow read for viewers/editors, write for editors
      match /objects/{objectId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).sheets.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).sheets.role == 'editor');
      }

      // RecordTemplates: Allow read for viewers/editors, write for owner only
      match /recordTemplates/{templateId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).sheets.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId);
      }

      // TemplateObjects: Allow read for viewers/editors, write for owner only
      match /templateObjects/{objectId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).sheets.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId);
      }

      // Dashboards: Allow read for viewers/editors, write for editors
      match /dashboards/{dashboardId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).dashboard.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).dashboard.role == 'editor');
      }

      // Metrics: Allow read for viewers/editors, write for editors
      match /metrics/{metricId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).metrics.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).metrics.role == 'editor');
      }

      // Actions: Allow read for viewers/editors, write for editors
      match /actions/{actionId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).actions.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).actions.role == 'editor');
      }

      // Financials: Allow read for viewers/editors, write for editors
      match /financials/{financialId} {
        allow read: if isBusinessOwner(businessId) ||
                      (isTeamMember(businessId) &&
                       getTeamMemberPermissions(businessId).financials.role in ['viewer', 'editor']);
        allow write: if isBusinessOwner(businessId) ||
                       (isTeamMember(businessId) &&
                        getTeamMemberPermissions(businessId).financials.role == 'editor');
      }
    }
  }
}